<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Music + 3D Pulse Orb</title>
  <style>
    html,body{margin:0;height:100%;background:#0b0f14;overflow:hidden}
    #ui{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none}
    button{pointer-events:auto;padding:.8rem 1.2rem;border-radius:12px;border:0;font-size:1rem}
  </style>
  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js" defer></script>
  <!-- Magenta bundle (exponerar window.mm) -->
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/dist/magentamusic.js" defer></script>
</head>
<body>
  <div id="ui"><button id="start">Starta musik & orb</button></div>
  <script src="https://cdn.jsdelivr.net/npm/tonal/browser/tonal.min.js"></script>
  <script src="chords.js"></script>
  <!-- <script src="backgroundinstruments.js"></script> -->
  <script src="helpers.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const mm = window.mm;

      // --- THREE scene ---
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0f14);
      const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
      camera.position.set(0, 0, 4);
      const renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(innerWidth, innerHeight);
      document.body.appendChild(renderer.domElement);

      const light = new THREE.PointLight(0xffffff, 10, 20); light.position.set(3,3,5); scene.add(light);
      const ambient = new THREE.AmbientLight(0x404040, 0.5); scene.add(ambient);

      const geo = new THREE.SphereGeometry(1, 64, 64);
      const mat = new THREE.MeshStandardMaterial({
        color: 0x4da3ff, metalness: 0.1, roughness: 0.2,
        emissive: 0x2255ff, emissiveIntensity: 0.2
      });
      const orb = new THREE.Mesh(geo, mat); scene.add(orb);

      let pulse = 0, targetPulse = 0;
      addEventListener('resize', () => {
        camera.aspect = innerWidth / innerHeight; camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
      });

      // --- MAGENTA: Improv över ackord ---
      // 1) Modell för ackords-bunden improvisation
      const improv = new mm.MusicRNN(
        "https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv"
      ); // :contentReference[oaicite:3]{index=3}

      // 2) Spelare (SoundFont) + pulse-callbacks
      const player = new mm.SoundFontPlayer(
        "https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus",
        undefined, undefined, undefined,
        {
          run: (note) => {
            const v = Math.min(1, Math.max(0, (note.velocity || 100) / 127));
            targetPulse = Math.max(targetPulse, 0.2 + 0.8 * v);
          },
          stop: () => {}
        }
      );

      // 3) Liten seed (kvantiserad 1 steg) funkar bra med ImprovRNN
      const SPQ = 4;              // steps per quarter
      const QPM = 100;            // tempo
      const STEPS_PER_CHORD = 16;  // hur länge varje ackord varar (kvantiserat)
      const NUM_REPS = 3;            // spela progressionen 3 ggr

      const qSeed = {
        quantizationInfo: { stepsPerQuarter: SPQ },
        notes: [{ pitch: 60, quantizedStartStep: 0, quantizedEndStep: 1, velocity: 100 }],
        totalQuantizedSteps: 1
      }; // :contentReference[oaicite:4]{index=4}

      async function playImprovOverRandomChords() {
            const SPQ = 4, QPM = 90, STEPS_PER_CHORD = 12, NUM_REPS = 3;
            const base = generateProgression({ key:'C', bars:8 }).chords;
            const chordProgression = Array.from({length: NUM_REPS}, () => base).flat();

            const guitar = makeGuitarStrumSeq(chordProgression, QPM, {
                program: 25,                 // 25=Steel (0-index), prova 24 för Nylon
                strings: 6,                  // 5 "strängar" ur voicingen
                strokePattern: ['D','D','D','U'], // enkel pop-strum (1 & 3)
                spreadMsDown: 50, spreadMsUp: 150, // down lite bredare än up
                humanVel: 24, anchor: 64
            });

            // 1) Melodi över ackord (ImprovRNN) – sänk temp för mer musikalitet
            const qSeed = { quantizationInfo:{stepsPerQuarter:SPQ},
                notes:[{pitch:60, quantizedStartStep:0, quantizedEndStep:1, velocity:100}],
                totalQuantizedSteps:1
            };
            const steps = chordProgression.length * STEPS_PER_CHORD - 1;
            const qMel = await improv.continueSequence(qSeed, steps, 0.78 /* lägre temp */, chordProgression);
            const mel  = mm.sequences.unquantizeSequence(qMel, QPM);
            // klipp melodin till ett trevligt register (C4–E5)
            mel.notes = mel.notes.map(n => {
            while (n.pitch < 60) n.pitch += 12;
            while (n.pitch > 76) n.pitch -= 12;
            n.velocity = 70 + Math.floor(Math.random()*25); // humanize velocity
            return n;
            });
            mel.notes.forEach(n => { n.program = 0; n.isDrum = false; });

            // 2) Piano-komp: välj EN av dessa:
            const pad = makePianoPadsVL(chordProgression, QPM, 4, 4 /*EP1*/);            
            const arp = makePianoArp(chordProgression, QPM, [0,1,2,3], 0);        // arpeggio (1-3-5-8)

            // 3) Bas + hi-hat du redan har
            const bass = makeBassSeq(chordProgression, QPM);
            const hats = makeHihat(Math.max(mel.totalTime, bass.totalTime), QPM);

            // 4) Mergea stämmor → spela
            const full = mergeSequences(mel, guitar, arp, bass, hats);
            await player.loadSamples(full);
            await player.start(full);
    }   


      // --- render-loop (orb) ---
      const clock = new THREE.Clock();
      (function animate(){
        requestAnimationFrame(animate);
        const dt = clock.getDelta();
        pulse += (targetPulse - pulse) * Math.min(1, dt*10);
        targetPulse *= Math.pow(0.4, dt);
        pulse *= Math.pow(0.9, dt);
        const s = 1 + 0.5 * pulse;
        orb.scale.set(s,s,s);
        mat.emissiveIntensity = 0.2 + 0.8 * pulse;
        orb.rotation.y += 0.2 * dt;
        renderer.render(scene, camera);
      })();

      // --- UI: start ---
      document.getElementById('start').addEventListener('click', async () => {
        document.getElementById('ui').style.display = 'none';
        player.resumeContext();              // väck ljud (autoplay-regler) :contentReference[oaicite:6]{index=6}
        await improv.initialize();           // ladda improv-modellen
        await playImprovOverRandomChords();  // kör!
      });
    });
  </script>
</body>
</html>
